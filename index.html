<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Roof Measurement Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 400px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .header h1 {
            font-size: 20px;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .header p {
            color: #6b7280;
            font-size: 14px;
        }
        
        /* Property Address Section */
        .section {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .section-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title::before {
            content: "üè†";
        }
        
        .address-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 12px;
        }
        
        .load-btn {
            width: 100%;
            padding: 12px;
            background: #374151;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .load-btn:hover {
            background: #4b5563;
        }
        
        /* Measurement Tools */
        .measurement-tools .section-title::before {
            content: "üìè";
        }
        
        .measurement-types {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .type-btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            color: white;
            transition: opacity 0.2s;
        }
        
        .type-btn:hover {
            opacity: 0.9;
        }
        
        .type-btn.perimeter {
            background: #ef4444;
        }
        
        .type-btn.ridge {
            background: #3b82f6;
        }
        
        .type-btn.ground {
            background: #10b981;
        }
        
        .type-btn.active {
            opacity: 1;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.8);
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .start-btn {
            width: 100%;
            padding: 12px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .start-btn:hover {
            background: #059669;
        }
        
        .control-row {
            display: flex;
            gap: 8px;
        }
        
        .control-btn {
            flex: 1;
            padding: 10px;
            background: #f3f4f6;
            color: #374151;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .control-btn:hover {
            background: #e5e7eb;
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Distance Results */
        .distance-results .section-title::before {
            content: "üìä";
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid;
        }
        
        .result-item.perimeter {
            border-left-color: #ef4444;
        }
        
        .result-item.ridge {
            border-left-color: #3b82f6;
        }
        
        .result-item.ground {
            border-left-color: #10b981;
        }
        
        .result-item.total {
            background: #1f2937;
            color: white;
            border-left-color: #fbbf24;
            font-weight: 600;
        }
        
        .result-label {
            font-size: 14px;
        }
        
        .result-value {
            font-weight: 600;
        }
        
        /* Material Calculator */
        .material-calculator .section-title::before {
            content: "üí°";
        }
        
        .calculator-config {
            background: #f3f4f6;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .config-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .config-row:last-child {
            margin-bottom: 0;
        }
        
        .config-group {
            flex: 1;
        }
        
        .config-label {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .config-select, .config-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .material-items {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .material-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s;
        }
        
        .material-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .material-card.lights {
            border-left-color: #fbbf24;
        }
        
        .material-card.wire {
            border-left-color: #3b82f6;
        }
        
        .material-card.clips {
            border-left-color: #8b5cf6;
        }
        
        .material-card.labor {
            border-left-color: #10b981;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
        }
        
        .card-badge {
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .card-badge.editable:hover {
            background: #059669;
        }
        
        .card-details {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .card-cost {
            font-weight: 700;
            color: #1f2937;
            font-size: 18px;
        }
        
        .editable-input {
            background: transparent;
            border: 1px dashed #d1d5db;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: inherit;
            font-weight: inherit;
            color: inherit;
            width: auto;
            min-width: 60px;
        }
        
        .editable-input:focus {
            outline: none;
            border-color: #3b82f6;
            border-style: solid;
            background: white;
        }
        
        .summary-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid;
        }
        
        .summary-card.subtotal {
            border-left-color: #f59e0b;
        }
        
        .summary-card.profit {
            border-left-color: #10b981;
        }
        
        .summary-card.total {
            border-left-color: #1f2937;
            background: #1f2937;
            color: white;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .summary-label {
            font-size: 14px;
            font-weight: 500;
        }
        
        .summary-value {
            font-size: 16px;
            font-weight: 700;
        }
        
        .margin-indicator {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .margin-warning {
            color: #ef4444;
        }
        
        .margin-good {
            color: #10b981;
        }
        
        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        #map.measuring {
            cursor: crosshair !important;
        }
        
        #map.measuring * {
            cursor: crosshair !important;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #f9fafb;
            color: #6b7280;
            font-size: 16px;
        }
        
        /* Live Stats Overlay */
        .live-stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 1000;
            display: none;
        }
        
        .live-stats h4 {
            margin-bottom: 12px;
            color: #1f2937;
            font-size: 14px;
        }
        
        .live-stats .stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        .stat-label {
            color: #6b7280;
        }
        
        .stat-value {
            font-weight: 600;
            color: #1f2937;
        }
        
        .no-measurements {
            text-align: center;
            color: #9ca3af;
            font-size: 14px;
            padding: 20px;
        }
        
        /* Google Places Autocomplete Styling */
        .pac-container {
            background-color: white;
            z-index: 1000;
            position: fixed;
            display: inline-block;
            float: left;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: 2px;
        }
        
        .pac-item {
            cursor: pointer;
            padding: 12px 16px;
            font-size: 14px;
            color: #374151;
            border-bottom: 1px solid #f3f4f6;
            line-height: 1.4;
        }
        
        .pac-item:last-child {
            border-bottom: none;
        }
        
        .pac-item:hover {
            background-color: #f9fafb;
        }
        
        .pac-item-selected {
            background-color: #3b82f6 !important;
            color: white !important;
        }
        
        .pac-matched {
            font-weight: 600;
        }
        
        .pac-item-query {
            font-size: 16px;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Header -->
            <div class="header">
                <h1>Measurement</h1>
                <p>Measure roof lines and calculate materials</p>
            </div>
            
            <!-- Property Address -->
            <div class="section">
                <div class="section-title">Property Address</div>
                <input 
                    type="text" 
                    class="address-input" 
                    id="address-input"
                    placeholder="Start typing address... (autocomplete enabled)"
                />
                <button class="load-btn" onclick="searchAddress()">
                    üè† Load Property
                </button>
                <p style="color: #6b7280; font-size: 11px; margin-top: 8px;">
                    üí° Address suggestions will appear as you type. Click a suggestion or press "Load Property"
                </p>
            </div>
            
            <!-- Measurement Tools -->
            <div class="section">
                <div class="section-title">Measurement Tools</div>
                <p style="color: #6b7280; font-size: 12px; margin-bottom: 12px;">Select type and control drawing</p>
                
                <div class="measurement-types">
                    <button class="type-btn perimeter active" onclick="setType('perimeter')">
                        üî¥ Perimeter
                    </button>
                    <button class="type-btn ridge" onclick="setType('ridge')">
                        üîµ Ridge
                    </button>
                    <button class="type-btn ground" onclick="setType('ground')">
                        üü¢ Ground
                    </button>
                </div>
                
                <div class="controls">
                    <button class="start-btn" id="start-btn" onclick="startMeasuring()">
                        ‚ö° Start Measuring
                    </button>
                    <div class="control-row" id="control-row" style="display: none;">
                        <button class="control-btn" onclick="undoPoint()">‚Ü©Ô∏è Undo</button>
                        <button class="control-btn" onclick="clearCurrent()">üóëÔ∏è Clear</button>
                        <button class="control-btn" onclick="saveMeasurement()">üíæ Save</button>
                    </div>
                </div>
            </div>
            
            <!-- Distance Results -->
            <div class="section">
                <div class="section-title">Distance Results</div>
                <div id="distance-results">
                    <div class="no-measurements">No measurements yet</div>
                </div>
            </div>
            
            <!-- Material Calculator -->
            <div class="section">
                <div class="section-title">Cost Calculator</div>
                <p style="color: #6b7280; font-size: 12px; margin-bottom: 12px;">Admin pricing control with ceiling/floor for sales negotiations - all values are editable</p>
                
                <div class="calculator-config" id="calculator-config">
                    <!-- Configuration will be populated by JavaScript -->
                </div>
                
                <div class="material-items" id="material-items">
                    <div class="no-measurements">Start measuring to see material estimates</div>
                </div>
            </div>
        </div>
        
        <!-- Map Container -->
        <div class="map-container">
            <div id="map" class="loading">Loading Google Maps...</div>
            
            <!-- Live Stats Overlay -->
            <div class="live-stats" id="live-stats">
                <h4>Current Segment</h4>
                <div class="stat">
                    <span class="stat-label">Type:</span>
                    <span class="stat-value" id="current-type">perimeter</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Points:</span>
                    <span class="stat-value" id="current-points">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Distance:</span>
                    <span class="stat-value" id="current-distance">0.0 ft</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Replace with your Google Maps API key
        const API_KEY = 'AIzaSyB-Q8DaNs6F6sT93ukB-GibpSZvrQ57vAk';
        
        // Professional measurement state management
        const MeasurementState = {
            map: null,
            isActive: false,
            currentType: 'perimeter',
            activePoints: [],
            completedMeasurements: [],
            
            // Visual elements
            activePolyline: null,
            livePreviewLine: null,
            savedPolylines: [],
            savedMarkers: [],
            
            // Event listeners
            clickListener: null,
            mouseMoveListener: null,
            
            // Reset all state
            reset() {
                this.isActive = false;
                this.activePoints = [];
                this.clearVisualElements();
                this.removeEventListeners();
            },
            
            clearVisualElements() {
                if (this.activePolyline) {
                    this.activePolyline.setMap(null);
                    this.activePolyline = null;
                }
                if (this.livePreviewLine) {
                    this.livePreviewLine.setMap(null);
                    this.livePreviewLine = null;
                }
            },
            
            removeEventListeners() {
                if (this.clickListener) {
                    google.maps.event.removeListener(this.clickListener);
                    this.clickListener = null;
                }
                if (this.mouseMoveListener) {
                    google.maps.event.removeListener(this.mouseMoveListener);
                    this.mouseMoveListener = null;
                }
            }
        };
        
        // Legacy variables for backward compatibility
        let map = null;
        let isMeasuring = false;
        let currentType = 'perimeter';
        let currentPoints = [];
        let measurements = [];
        let activePolyline = null;
        let savedPolylines = [];
        let savedMarkers = [];
        let clickListener = null;
        let mouseMoveListener = null;
        let livePreviewLine = null;
        
        // Colors
        const COLORS = {
            perimeter: '#EF4444',
            ridge: '#3B82F6',
            ground: '#10B981'
        };
        
        // Hardware catalog and pricing
        const ledColors = {
            'warm-white': { name: 'Warm White', price: 0.75 },
            'cool-white': { name: 'Cool White', price: 0.75 },
            'red': { name: 'Red', price: 0.85 },
            'green': { name: 'Green', price: 0.85 },
            'blue': { name: 'Blue', price: 0.85 },
            'multicolor': { name: 'Multicolor', price: 1.25 }
        };
        
        const clipTypes = {
            'all-in-one': { name: 'All-In-One Seasonal Clip', price: 0.11, description: 'Universal clip for seasonal lights' },
            'led-plus': { name: 'LED Clip-All-Plus', price: 0.11, description: 'Enhanced universal clip' },
            'c9-circle': { name: 'C9 Circle Clip V2+', price: 0.21, description: 'Specific for C9 bulb sockets' },
            'shingle-tabs': { name: 'Shingle Tabs', price: 0.23, description: 'Light hangers for shingle roofs' },
            'parapet': { name: 'Parapet Clip', price: 0.42, description: 'Heavy-duty permanent mounting' },
            'magnetic': { name: 'Magnetic C9 Socket', price: 0.87, description: 'Magnetic mounting for metal' },
            'ground-stake': { name: '7.5" Light Stake', price: 0.46, description: 'Ground stakes for pathways' }
        };
        
        const wireSpecs = {
            type: 'C9 12AWG 1000ft',
            spoolLength: 1000,
            pricePerSpool: 283.99
        };
        
        // Project configuration
        let projectConfig = {
            ledColor1: 'warm-white',
            ledColor2: null,
            colorSplit: 100, // percentage for color1
            lightSpacing: 12,
            selectedClips: ['all-in-one'], // array of selected clip types
            clipQuantities: { 'all-in-one': 1 }, // quantity per clip type
            crewCount: 1,
            crewRate: 1.50,
            includeTakedown: false,
            marginFloor: 35,
            marginCeiling: 100,
            currentMargin: 60,
            wireBuffer: 15,
            complexityMultiplier: 1.0
        };
        
        // Load Google Maps
        function loadGoogleMaps() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=geometry,places&callback=initMap&loading=async`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
        
        // Initialize map with professional settings
        function initMap() {
            const mapOptions = {
                center: { lat: 32.7767, lng: -96.7970 }, // Dallas, TX
                zoom: 20,
                mapTypeId: 'satellite',
                tilt: 0,
                
                // Professional measurement optimizations
                clickableIcons: false,
                disableDoubleClickZoom: true, // Prevent accidental zoom during measurement
                gestureHandling: 'greedy',
                keyboardShortcuts: false,
                
                // Precision settings
                mapTypeControl: true,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                    position: google.maps.ControlPosition.TOP_CENTER,
                },
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_CENTER
                },
                streetViewControl: false,
                fullscreenControl: false
            };
            
            map = new google.maps.Map(document.getElementById('map'), mapOptions);
            MeasurementState.map = map;
            
            // Initialize autocomplete
            initAutocomplete();
        }
        
        // Initialize Google Places Autocomplete
        function initAutocomplete() {
            const input = document.getElementById('address-input');
            const autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['address'],
                componentRestrictions: { country: 'us' },
                fields: ['place_id', 'geometry', 'name', 'formatted_address']
            });
            
            // Set bounds to bias results (optional - can help with local results)
            autocomplete.setBounds(new google.maps.LatLngBounds(
                new google.maps.LatLng(25.0, -130.0), // Southwest US
                new google.maps.LatLng(49.0, -65.0)   // Northeast US
            ));
            
            // When place is selected
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) {
                    console.log('No details available for input: ' + place.name);
                    return;
                }
                
                // Center map on selected location
                map.setCenter(place.geometry.location);
                map.setZoom(20);
                
                // Optional: Show success message
                console.log('Loaded address: ' + place.formatted_address);
            });
        }
        
        // Set measurement type
        function setType(type) {
            currentType = type;
            document.getElementById('current-type').textContent = type;
            
            // Update active button
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.type-btn.${type}`).classList.add('active');
        }
        
        // Professional measurement initialization
        function startMeasuring() {
            // Reset any existing measurement state
            MeasurementState.reset();
            
            // Set new measurement state
            MeasurementState.isActive = true;
            MeasurementState.currentType = currentType;
            MeasurementState.activePoints = [];
            
            // Update legacy variables for compatibility
            isMeasuring = true;
            currentPoints = [];
            
            // Add crosshair cursor
            document.getElementById('map').classList.add('measuring');
            
            // Precise click handling without delays
            MeasurementState.clickListener = map.addListener('click', handleMeasurementClick);
            
            // Smooth mouse tracking without throttling for precision
            MeasurementState.mouseMoveListener = map.addListener('mousemove', handleMouseMove);
            
            // Update legacy variables
            clickListener = MeasurementState.clickListener;
            mouseMoveListener = MeasurementState.mouseMoveListener;
            
            updateUI();
        }
        
        // Professional click handler
        function handleMeasurementClick(event) {
            if (!MeasurementState.isActive && !isMeasuring) return;
            
            const newPoint = {
                lat: event.latLng.lat(),
                lng: event.latLng.lng()
            };
            
            // Add to both state systems
            MeasurementState.activePoints.push(newPoint);
            currentPoints.push(newPoint);
            
            // Immediate visual updates
            updateActivePolyline();
            updateLiveStats();
            updateLivePreview(event.latLng);
        }
        
        // Professional mouse move handler
        function handleMouseMove(event) {
            if (!MeasurementState.isActive || MeasurementState.activePoints.length === 0) return;
            updateLivePreview(event.latLng);
        }
        
        // Professional live preview with precise rendering
        function updateLivePreview(mousePosition) {
            const points = MeasurementState.activePoints.length > 0 ? MeasurementState.activePoints : currentPoints;
            if (points.length === 0) return;
            
            const lastPoint = points[points.length - 1];
            const previewPath = [
                new google.maps.LatLng(lastPoint.lat, lastPoint.lng),
                mousePosition
            ];
            
            if (MeasurementState.livePreviewLine) {
                MeasurementState.livePreviewLine.setPath(previewPath);
            } else {
                MeasurementState.livePreviewLine = new google.maps.Polyline({
                    path: previewPath,
                    geodesic: true,
                    strokeColor: COLORS[MeasurementState.currentType],
                    strokeOpacity: 0.85,
                    strokeWeight: 3,
                    strokePattern: [10, 5], // Professional dash pattern
                    zIndex: 1000, // Ensure it's above other elements
                    map: map
                });
                
                // Update legacy reference
                livePreviewLine = MeasurementState.livePreviewLine;
            }
        }
        
        // Professional cleanup
        function clearLivePreview() {
            if (MeasurementState.livePreviewLine) {
                MeasurementState.livePreviewLine.setMap(null);
                MeasurementState.livePreviewLine = null;
            }
            if (livePreviewLine) {
                livePreviewLine.setMap(null);
                livePreviewLine = null;
            }
        }
        
        // Professional polyline rendering
        function updateActivePolyline() {
            const points = MeasurementState.activePoints.length > 0 ? MeasurementState.activePoints : currentPoints;
            
            if (points.length === 0) {
                if (MeasurementState.activePolyline) {
                    MeasurementState.activePolyline.setMap(null);
                    MeasurementState.activePolyline = null;
                }
                if (activePolyline) {
                    activePolyline.setMap(null);
                    activePolyline = null;
                }
                return;
            }
            
            const pathPoints = points.map(pt => new google.maps.LatLng(pt.lat, pt.lng));
            
            if (points.length === 1) {
                // Clear existing polyline for single point
                if (MeasurementState.activePolyline) {
                    MeasurementState.activePolyline.setMap(null);
                }
                
                // Create new polyline for measurement in progress
                MeasurementState.activePolyline = new google.maps.Polyline({
                    path: pathPoints,
                    geodesic: true,
                    strokeColor: COLORS[MeasurementState.currentType],
                    strokeOpacity: 1.0,
                    strokeWeight: 4,
                    zIndex: 500,
                    map: map
                });
                
                // Update legacy reference
                activePolyline = MeasurementState.activePolyline;
            } else if (points.length > 1) {
                // Update existing polyline path
                if (MeasurementState.activePolyline) {
                    MeasurementState.activePolyline.setPath(pathPoints);
                } else {
                    // Create if it doesn't exist
                    MeasurementState.activePolyline = new google.maps.Polyline({
                        path: pathPoints,
                        geodesic: true,
                        strokeColor: COLORS[MeasurementState.currentType],
                        strokeOpacity: 1.0,
                        strokeWeight: 4,
                        zIndex: 500,
                        map: map
                    });
                    activePolyline = MeasurementState.activePolyline;
                }
            }
        }
        
        // Calculate distance
        function calculateDistance(points) {
            if (points.length < 2) return 0;
            
            let total = 0;
            for (let i = 0; i < points.length - 1; i++) {
                const distance = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(points[i].lat, points[i].lng),
                    new google.maps.LatLng(points[i + 1].lat, points[i + 1].lng)
                );
                total += distance;
            }
            
            return total * 3.28084; // Convert to feet
        }
        
        // Save measurement
        function saveMeasurement() {
            if (currentPoints.length < 2) return;
            
            const measurement = {
                type: currentType,
                points: currentPoints,
                distance: calculateDistance(currentPoints)
            };
            
            measurements.push(measurement);
            
            if (activePolyline) {
                activePolyline.setMap(null);
                activePolyline = null;
            }
            
            // Clean up measurement state
            currentPoints = [];
            isMeasuring = false;
            
            // Remove listeners and cursor
            if (clickListener) {
                google.maps.event.removeListener(clickListener);
            }
            if (mouseMoveListener) {
                google.maps.event.removeListener(mouseMoveListener);
            }
            
            // Clear live preview and cursor
            clearLivePreview();
            document.getElementById('map').classList.remove('measuring');
            
            drawAllMeasurements();
            updateDistanceResults();
            updateMaterialEstimate();
            updateUI();
        }
        
        // Draw all saved measurements
        function drawAllMeasurements() {
            // Clear existing
            savedPolylines.forEach(p => p.setMap(null));
            savedMarkers.forEach(m => m.setMap(null));
            savedPolylines = [];
            savedMarkers = [];
            
            measurements.forEach(measurement => {
                const color = COLORS[measurement.type];
                
                // Polyline
                const polyline = new google.maps.Polyline({
                    path: measurement.points.map(pt => new google.maps.LatLng(pt.lat, pt.lng)),
                    geodesic: true,
                    strokeColor: color,
                    strokeOpacity: 1,
                    strokeWeight: 3,
                    map: map
                });
                savedPolylines.push(polyline);
                
                // Markers
                measurement.points.forEach(point => {
                    const marker = new google.maps.Marker({
                        position: new google.maps.LatLng(point.lat, point.lng),
                        map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 2,
                            fillColor: color,
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 1
                        },
                        clickable: false,
                        optimized: false,
                        zIndex: -100
                    });
                    savedMarkers.push(marker);
                });
            });
        }
        
        // Undo point
        function undoPoint() {
            if (currentPoints.length > 0) {
                currentPoints.pop();
                updateActivePolyline();
                updateLiveStats();
            }
        }
        
        // Professional measurement cleanup
        function clearCurrent() {
            // Reset professional state
            MeasurementState.reset();
            
            // Reset legacy variables
            currentPoints = [];
            isMeasuring = false;
            
            if (activePolyline) {
                activePolyline.setMap(null);
                activePolyline = null;
            }
            
            // Clear visual elements
            clearLivePreview();
            document.getElementById('map').classList.remove('measuring');
            
            updateUI();
        }
        
        // Search address (fallback for manual search)
        function searchAddress() {
            const address = document.getElementById('address-input').value;
            if (!address) return;
            
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 
                address: address,
                componentRestrictions: { country: 'US' }
            }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    map.setCenter(results[0].geometry.location);
                    map.setZoom(20);
                } else {
                    alert('Address not found. Please try a more specific address.');
                }
            });
        }
        
        // Update UI
        function updateUI() {
            const startBtn = document.getElementById('start-btn');
            const controlRow = document.getElementById('control-row');
            const liveStats = document.getElementById('live-stats');
            
            if (isMeasuring) {
                startBtn.style.display = 'none';
                controlRow.style.display = 'flex';
                liveStats.style.display = 'block';
            } else {
                startBtn.style.display = 'block';
                controlRow.style.display = 'none';
                liveStats.style.display = 'none';
            }
        }
        
        // Update live stats
        function updateLiveStats() {
            document.getElementById('current-points').textContent = currentPoints.length;
            const distance = calculateDistance(currentPoints);
            document.getElementById('current-distance').textContent = distance.toFixed(1) + ' ft';
        }
        
        // Update distance results
        function updateDistanceResults() {
            const perimeterDist = measurements.filter(m => m.type === 'perimeter').reduce((sum, m) => sum + m.distance, 0);
            const ridgeDist = measurements.filter(m => m.type === 'ridge').reduce((sum, m) => sum + m.distance, 0);
            const groundDist = measurements.filter(m => m.type === 'ground').reduce((sum, m) => sum + m.distance, 0);
            const totalDist = perimeterDist + ridgeDist + groundDist;
            
            let html = '';
            
            if (perimeterDist > 0) {
                html += `<div class="result-item perimeter">
                    <span class="result-label">üî¥ Perimeter</span>
                    <span class="result-value">${perimeterDist.toFixed(1)} ft</span>
                </div>`;
            }
            
            if (ridgeDist > 0) {
                html += `<div class="result-item ridge">
                    <span class="result-label">üîµ Ridge</span>
                    <span class="result-value">${ridgeDist.toFixed(1)} ft</span>
                </div>`;
            }
            
            if (groundDist > 0) {
                html += `<div class="result-item ground">
                    <span class="result-label">üü¢ Ground</span>
                    <span class="result-value">${groundDist.toFixed(1)} ft</span>
                </div>`;
            }
            
            if (totalDist > 0) {
                html += `<div class="result-item total">
                    <span class="result-label">Total Distance</span>
                    <span class="result-value">${totalDist.toFixed(1)} ft</span>
                </div>`;
            }
            
            document.getElementById('distance-results').innerHTML = html || '<div class="no-measurements">No measurements yet</div>';
        }
        
        // Update material estimate with hardware-specific cards
        function updateMaterialEstimate() {
            const totalDist = measurements.reduce((sum, m) => sum + m.distance, 0);
            
            if (totalDist === 0) {
                document.getElementById('material-items').innerHTML = '<div class="no-measurements">Start measuring to see material estimates</div>';
                return;
            }
            
            // Calculate quantities
            const lightsNeeded = Math.ceil((totalDist * 12) / projectConfig.lightSpacing);
            const wireNeeded = Math.ceil(totalDist * (1 + projectConfig.wireBuffer / 100));
            const spoolsNeeded = Math.ceil(wireNeeded / wireSpecs.spoolLength);
            
            // Calculate LED costs (with color mixing)
            let lightCost = 0;
            if (projectConfig.ledColor2) {
                const color1Lights = Math.ceil(lightsNeeded * (projectConfig.colorSplit / 100));
                const color2Lights = lightsNeeded - color1Lights;
                lightCost = (color1Lights * ledColors[projectConfig.ledColor1].price) + 
                           (color2Lights * ledColors[projectConfig.ledColor2].price);
            } else {
                lightCost = lightsNeeded * ledColors[projectConfig.ledColor1].price;
            }
            
            // Calculate wire cost
            const wireCost = spoolsNeeded * wireSpecs.pricePerSpool;
            
            // Calculate clips cost
            let clipCost = 0;
            let clipDetails = [];
            projectConfig.selectedClips.forEach(clipId => {
                const quantity = projectConfig.clipQuantities[clipId] || 1;
                const neededPerType = Math.ceil(lightsNeeded / quantity);
                const cost = neededPerType * clipTypes[clipId].price;
                clipCost += cost;
                clipDetails.push(`${neededPerType} ${clipTypes[clipId].name}`);
            });
            
            // Calculate labor with complexity multiplier
            const baseInstallCost = totalDist * projectConfig.crewRate * projectConfig.crewCount;
            const baseTakedownCost = projectConfig.includeTakedown ? totalDist * (projectConfig.crewRate * 0.6) * projectConfig.crewCount : 0;
            const installCost = baseInstallCost * projectConfig.complexityMultiplier;
            const takedownCost = baseTakedownCost * projectConfig.complexityMultiplier;
            const totalLaborCost = installCost + takedownCost;
            
            // Calculate totals
            const materialSubtotal = lightCost + wireCost + clipCost;
            const subtotal = materialSubtotal + totalLaborCost;
            const priceCeiling = subtotal * (1 + projectConfig.marginCeiling / 100);
            const priceFloor = subtotal * (1 + projectConfig.marginFloor / 100);
            const currentPrice = subtotal * (1 + projectConfig.currentMargin / 100);
            const currentProfit = currentPrice - subtotal;
            
            // Generate color description
            let colorDescription = ledColors[projectConfig.ledColor1].name;
            if (projectConfig.ledColor2) {
                colorDescription += ` (${projectConfig.colorSplit}%) + ${ledColors[projectConfig.ledColor2].name} (${100-projectConfig.colorSplit}%)`;
            }
            
            const html = `
                <div class="material-card lights">
                    <div class="card-header">
                        <div class="card-title">üí° LED Lights</div>
                        <div class="card-badge editable" onclick="editLEDConfig()">${projectConfig.lightSpacing}" spacing</div>
                    </div>
                    <div class="card-details">
                        ${lightsNeeded} lights ‚Ä¢ ${colorDescription}
                        <br><small style="color: #6b7280;">Click to change colors or spacing</small>
                    </div>
                    <div class="card-cost">$${lightCost.toFixed(2)}</div>
                </div>
                
                <div class="material-card wire">
                    <div class="card-header">
                        <div class="card-title">üîå Wire (${wireSpecs.type})</div>
                        <div class="card-badge editable" onclick="editWireConfig()">+${projectConfig.wireBuffer}% buffer</div>
                    </div>
                    <div class="card-details">
                        ${wireNeeded} ft needed ‚Ä¢ ${spoolsNeeded} spool${spoolsNeeded > 1 ? 's' : ''}
                        <br><small style="color: #6b7280;">${spoolsNeeded * wireSpecs.spoolLength - wireNeeded} ft remaining</small>
                    </div>
                    <div class="card-cost">$${wireCost.toFixed(2)}</div>
                </div>
                
                <div class="material-card clips">
                    <div class="card-header">
                        <div class="card-title">üìé Mounting Clips</div>
                        <div class="card-badge editable" onclick="editClipConfig()">Configure</div>
                    </div>
                    <div class="card-details">
                        ${clipDetails.join('<br>')}
                        <br><small style="color: #6b7280;">Click to change types and quantities</small>
                    </div>
                    <div class="card-cost">$${clipCost.toFixed(2)}</div>
                </div>
                
                <div class="material-card labor">
                    <div class="card-header">
                        <div class="card-title">üë∑ Labor Cost</div>
                        <div class="card-badge editable" onclick="editLaborConfig()">${projectConfig.complexityMultiplier.toFixed(1)}x complexity</div>
                    </div>
                    <div class="card-details">
                        Install: $${installCost.toFixed(2)} (${totalDist.toFixed(1)} ft √ó $${projectConfig.crewRate}/ft √ó ${projectConfig.crewCount} crew${projectConfig.crewCount > 1 ? 's' : ''} √ó ${projectConfig.complexityMultiplier.toFixed(1)}x)
                        ${projectConfig.includeTakedown ? `<br>Takedown: $${takedownCost.toFixed(2)} (60% rate √ó ${projectConfig.complexityMultiplier.toFixed(1)}x complexity)` : ''}
                        <br><small style="color: #6b7280;">Complexity multiplier affects labor costs</small>
                    </div>
                    <div class="card-cost">$${totalLaborCost.toFixed(2)}</div>
                </div>
                
                <div class="summary-card subtotal">
                    <div class="summary-row">
                        <div class="summary-label">Material Subtotal</div>
                        <div class="summary-value">$${materialSubtotal.toFixed(2)}</div>
                    </div>
                </div>
                
                <div class="summary-card subtotal">
                    <div class="summary-row">
                        <div class="summary-label">Subtotal (Materials + Labor)</div>
                        <div class="summary-value">$${subtotal.toFixed(2)}</div>
                    </div>
                </div>
                
                <div class="summary-card profit">
                    <div class="summary-row">
                        <div class="summary-label">Quote Margin (${projectConfig.currentMargin}%)</div>
                        <div class="summary-value">$${currentPrice.toFixed(2)}</div>
                    </div>
                    <div style="margin-top: 12px; position: relative;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px; color: #6b7280;">
                            <span>Floor: ${projectConfig.marginFloor}% ($${priceFloor.toFixed(2)})</span>
                            <span>Ceiling: ${projectConfig.marginCeiling}% ($${priceCeiling.toFixed(2)})</span>
                        </div>
                        <input type="range" min="${projectConfig.marginFloor}" max="${projectConfig.marginCeiling}" value="${projectConfig.currentMargin}" 
                               style="width: 100%; height: 8px; border-radius: 5px; background: linear-gradient(to right, #ef4444 0%, #f59e0b 50%, #10b981 100%); outline: none; -webkit-appearance: none;" 
                               oninput="projectConfig.currentMargin = parseInt(this.value); updateMaterialEstimate();">
                        <div style="text-align: center; margin-top: 4px; font-size: 12px; color: #374151; font-weight: 600;">
                            ${projectConfig.currentMargin}% Margin
                        </div>
                    </div>
                </div>
                
                <div class="summary-card total">
                    <div class="summary-row">
                        <div class="summary-label">Base Cost (Materials + Labor)</div>
                        <div class="summary-value">$${subtotal.toFixed(2)}</div>
                    </div>
                    <div class="margin-indicator" style="color: #9ca3af; margin-top: 8px;">
                        <strong>Current Quote:</strong> $${currentPrice.toFixed(2)} (${projectConfig.currentMargin}% margin)<br>
                        <strong>Profit:</strong> $${currentProfit.toFixed(2)}
                    </div>
                </div>
            `;
            
            document.getElementById('material-items').innerHTML = html;
        }
        
        // Hardware-specific configuration functions
        function editLEDConfig() {
            const modal = createModal('LED Configuration', `
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Primary Color:</label>
                    <select id="color1-select" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        ${Object.entries(ledColors).map(([key, color]) => 
                            `<option value="${key}" ${key === projectConfig.ledColor1 ? 'selected' : ''}>${color.name} - $${color.price}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">
                        <input type="checkbox" id="use-second-color" ${projectConfig.ledColor2 ? 'checked' : ''}> 
                        Use second color (mix)
                    </label>
                </div>
                
                <div id="second-color-config" style="display: ${projectConfig.ledColor2 ? 'block' : 'none'}; margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Secondary Color:</label>
                    <select id="color2-select" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; margin-bottom: 8px;">
                        ${Object.entries(ledColors).map(([key, color]) => 
                            `<option value="${key}" ${key === projectConfig.ledColor2 ? 'selected' : ''}>${color.name} - $${color.price}</option>`
                        ).join('')}
                    </select>
                    
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Primary Color Split (%):</label>
                    <input type="range" id="color-split" min="10" max="90" value="${projectConfig.colorSplit}" 
                           style="width: 100%;" oninput="document.getElementById('split-value').textContent = this.value + '%'">
                    <div style="text-align: center; color: #6b7280; font-size: 12px;">
                        <span id="split-value">${projectConfig.colorSplit}%</span> primary, ${100-projectConfig.colorSplit}% secondary
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Light Spacing (inches):</label>
                    <input type="number" id="light-spacing" value="${projectConfig.lightSpacing}" min="6" max="24" 
                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
            `);
            
            document.getElementById('use-second-color').onchange = function() {
                document.getElementById('second-color-config').style.display = this.checked ? 'block' : 'none';
            };
            
            modal.onSave = function() {
                projectConfig.ledColor1 = document.getElementById('color1-select').value;
                projectConfig.ledColor2 = document.getElementById('use-second-color').checked ? 
                    document.getElementById('color2-select').value : null;
                projectConfig.colorSplit = parseInt(document.getElementById('color-split').value);
                projectConfig.lightSpacing = parseInt(document.getElementById('light-spacing').value);
                updateMaterialEstimate();
            };
        }
        
        function editWireConfig() {
            const modal = createModal('Wire Configuration', `
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Wire Type:</label>
                    <div style="padding: 8px; background: #f3f4f6; border-radius: 4px; color: #6b7280;">
                        ${wireSpecs.type} - $${wireSpecs.pricePerSpool} per ${wireSpecs.spoolLength}ft spool
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Wire Buffer (%):</label>
                    <input type="number" id="wire-buffer-input" value="${projectConfig.wireBuffer}" min="0" max="50" 
                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                    <small style="color: #6b7280;">Extra wire for connections, routing, and waste</small>
                </div>
            `);
            
            modal.onSave = function() {
                projectConfig.wireBuffer = parseInt(document.getElementById('wire-buffer-input').value);
                updateMaterialEstimate();
            };
        }
        
        function editClipConfig() {
            const clipOptions = Object.entries(clipTypes).map(([key, clip]) => `
                <div style="margin-bottom: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <label style="display: flex; align-items: center; margin-bottom: 8px;">
                        <input type="checkbox" value="${key}" ${projectConfig.selectedClips.includes(key) ? 'checked' : ''}
                               style="margin-right: 8px;"> 
                        <strong>${clip.name}</strong> - $${clip.price} each
                    </label>
                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 8px;">${clip.description}</div>
                    <label style="display: block; font-size: 12px;">
                        Quantity per light: 
                        <input type="number" min="1" max="5" value="${projectConfig.clipQuantities[key] || 1}"
                               data-clip="${key}" class="clip-quantity"
                               style="width: 60px; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; margin-left: 4px;">
                    </label>
                </div>
            `).join('');
            
            const modal = createModal('Mounting Clips Configuration', clipOptions);
            
            modal.onSave = function() {
                const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
                const quantities = modal.querySelectorAll('.clip-quantity');
                
                projectConfig.selectedClips = [];
                projectConfig.clipQuantities = {};
                
                checkboxes.forEach(cb => {
                    if (cb.checked) {
                        projectConfig.selectedClips.push(cb.value);
                    }
                });
                
                quantities.forEach(input => {
                    const clipId = input.getAttribute('data-clip');
                    projectConfig.clipQuantities[clipId] = parseInt(input.value);
                });
                
                if (projectConfig.selectedClips.length === 0) {
                    projectConfig.selectedClips = ['all-in-one'];
                    projectConfig.clipQuantities['all-in-one'] = 1;
                }
                
                updateMaterialEstimate();
            };
        }
        
        function editLaborConfig() {
            const modal = createModal('Labor Configuration', `
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Number of Crews (2 people each):</label>
                    <input type="number" id="crew-count-input" value="${projectConfig.crewCount}" min="1" max="5" 
                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Rate per foot per crew ($):</label>
                    <input type="number" id="crew-rate-input" value="${projectConfig.crewRate}" min="0.50" max="5.00" step="0.25"
                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="include-takedown" ${projectConfig.includeTakedown ? 'checked' : ''}
                               style="margin-right: 8px;"> 
                        Include takedown labor for January (60% of install rate)
                    </label>
                </div>
            `);
            
            modal.onSave = function() {
                projectConfig.crewCount = parseInt(document.getElementById('crew-count-input').value);
                projectConfig.crewRate = parseFloat(document.getElementById('crew-rate-input').value);
                projectConfig.includeTakedown = document.getElementById('include-takedown').checked;
                updateMaterialEstimate();
            };
        }
        
        // Modal utility function
        function createModal(title, content) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 16px 0; color: #1f2937;">${title}</h3>
                    ${content}
                    <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('[style*=fixed]').remove()" 
                                style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="this.closest('[style*=fixed]').onSave(); this.closest('[style*=fixed]').remove()" 
                                style="padding: 8px 16px; border: none; background: #3b82f6; color: white; border-radius: 4px; cursor: pointer;">
                            Save
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            return modal;
        }
        
        // Update calculator configuration UI
        function updateCalculatorConfig() {
            const configHtml = `
                <div class="config-row">
                    <div class="config-group" style="width: 100%;">
                        <label class="config-label" id="complexity-multiplier-label">Labor Complexity Multiplier (${projectConfig.complexityMultiplier.toFixed(1)}x)</label>
                        <input type="range" min="1.0" max="2.0" step="0.1" value="${projectConfig.complexityMultiplier}" 
                               class="config-input" style="margin-top: 4px; width: 100%;"
                               oninput="projectConfig.complexityMultiplier = parseFloat(this.value); document.getElementById('complexity-multiplier-label').textContent = 'Labor Complexity Multiplier (' + this.value + 'x)'; updateMaterialEstimate();">
                    </div>
                </div>
            `;
            document.getElementById('calculator-config').innerHTML = configHtml;
        }
        
        // Load maps on page load
        window.onload = () => {
            loadGoogleMaps();
            updateCalculatorConfig();
        };
    </script>
</body>
</html>