<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Roof Measurement Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .section-subtitle {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        /* Property Address Section */
        .address-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        
        .address-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .load-property-btn {
            width: 100%;
            background: #475569;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        
        .load-property-btn:hover {
            background: #334155;
        }
        
        .address-help {
            color: #64748b;
            font-size: 13px;
            margin-top: 8px;
        }
        
        /* Measurement Tools */
        .measurement-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .measurement-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: opacity 0.2s;
        }
        
        .measurement-btn:hover {
            opacity: 0.9;
        }
        
        .measurement-btn.perimeter {
            background: #dc2626;
            color: white;
        }
        
        .measurement-btn.ridge {
            background: #2563eb;
            color: white;
        }
        
        .measurement-btn.ground {
            background: #059669;
            color: white;
        }
        
        .start-measuring-btn {
            width: 100%;
            background: #059669;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        
        .start-measuring-btn:hover {
            background: #047857;
        }
        
        /* Map Container */
        #map {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            margin: 16px 0;
            border: 2px solid #e2e8f0;
        }
        
        /* Distance Results */
        .distance-results {
            color: #64748b;
            text-align: center;
            padding: 40px 20px;
        }
        
        /* Pricing Configuration */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .form-select, .form-input {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s;
        }
        
        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .complexity-section {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .complexity-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Generate Quote Button */
        .generate-quote-btn {
            width: 100%;
            background: #059669;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s;
            margin-top: 24px;
        }
        
        .generate-quote-btn:hover {
            background: #047857;
        }
        
        .export-note {
            color: #64748b;
            font-size: 13px;
            text-align: center;
            margin-top: 8px;
        }
        
        /* Material Breakdown */
        .material-breakdown {
            margin-top: 20px;
            display: none;
        }
        
        .material-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .material-item:last-child {
            border-bottom: none;
        }
        
        .material-name {
            font-weight: 500;
            color: #1e293b;
        }
        
        .material-details {
            font-size: 13px;
            color: #64748b;
        }
        
        .material-cost {
            font-weight: 600;
            color: #1e293b;
        }
        
        .total-section {
            background: #1e293b;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 16px;
            text-align: center;
        }
        
        .total-label {
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .total-amount {
            font-size: 32px;
            font-weight: 700;
        }
        
        /* Responsive */
        @media (max-width: 640px) {
            .container {
                padding: 16px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .measurement-buttons {
                flex-direction: column;
            }
        }
        
        .live-stats {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Property Address -->
        <div class="section">
            <div class="section-header">
                <span>üè†</span>
                <h2 class="section-title">Property Address</h2>
            </div>
            <input 
                type="text" 
                class="address-input" 
                id="property-address"
                placeholder="5506 E County Rd 60, Midland, TX 79705, USA"
                value="5506 E County Rd 60, Midland, TX 79705, USA"
            >
            <button class="load-property-btn" onclick="loadProperty()">
                <span>üè†</span>
                Load Property
            </button>
            <p class="address-help">
                Address suggestions will appear as you type. Click a suggestion or press "Load Property"
            </p>
        </div>

        <!-- Measurement Tools -->
        <div class="section">
            <div class="section-header">
                <span>üè†</span>
                <h2 class="section-title">Measurement Tools</h2>
            </div>
            <p class="section-subtitle">Select type and control drawing</p>
            
            <div class="measurement-buttons">
                <button class="measurement-btn perimeter" onclick="setMeasurementType('perimeter')">
                    <span>üî¥</span>
                    Perimeter
                </button>
                <button class="measurement-btn ridge" onclick="setMeasurementType('ridge')">
                    <span>üîµ</span>
                    Ridge
                </button>
                <button class="measurement-btn ground" onclick="setMeasurementType('ground')">
                    <span>üü¢</span>
                    Ground
                </button>
                <button class="measurement-btn zoom" onclick="activateZoomTool()" style="background: #f59e0b; color: white;">
                    <span>üîç</span>
                    Zoom Tool
                </button>
            </div>
            
            <!-- Zoom Controls -->
            <div class="zoom-controls" id="zoom-controls" style="display: none; margin-bottom: 16px;">
                <div style="display: flex; gap: 8px;">
                    <button style="flex: 1; padding: 8px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;" onclick="selectZoomArea()">üìê Select Area</button>
                    <button style="flex: 1; padding: 8px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;" onclick="resetZoom()">üîÑ Reset</button>
                    <button style="flex: 1; padding: 8px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;" onclick="exitZoomMode()">‚ùå Exit</button>
                </div>
            </div>
            
            <button class="start-measuring-btn" onclick="startMeasuring()">
                <span>‚ö°</span>
                Start Measuring
            </button>
            
            <!-- Map will be inserted here -->
            <div id="map"></div>
        </div>

        <!-- Distance Results -->
        <div class="section">
            <div class="section-header">
                <span>üè†</span>
                <h2 class="section-title">Distance Results</h2>
            </div>
            <div class="distance-results" id="distance-results">
                No measurements yet
            </div>
        </div>

        <!-- Pricing Configuration -->
        <div class="section">
            <div class="section-header">
                <span>üè†</span>
                <h2 class="section-title">Pricing Configuration</h2>
            </div>
            <p class="section-subtitle">Click cards to edit pricing ‚Ä¢ Configure materials & labor costs</p>
            
            <div class="complexity-section">
                <h3 class="complexity-title">
                    <span>üèóÔ∏è</span>
                    Job Complexity Assessment
                </h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <span>üè†</span>
                            Stories
                        </label>
                        <select class="form-select" id="stories">
                            <option value="1">1 Story</option>
                            <option value="2">2 Story</option>
                            <option value="3">3+ Story</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <span>‚ö†Ô∏è</span>
                            Difficulty
                        </label>
                        <select class="form-select" id="difficulty">
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                            <option value="extreme">Extreme</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">
                        <span>üí∞</span>
                        Profit Margin (%)
                    </label>
                    <input type="number" class="form-input" id="profit-margin" value="35" min="0" max="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Show Breakdown</label>
                    <select class="form-select" id="show-breakdown">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Light Spacing (inches)</label>
                    <select class="form-select" id="light-spacing">
                        <option value="6">6"</option>
                        <option value="12" selected>12"</option>
                        <option value="18">18"</option>
                        <option value="24">24"</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Clip Spacing (inches)</label>
                    <select class="form-select" id="clip-spacing">
                        <option value="6">6"</option>
                        <option value="12" selected>12"</option>
                        <option value="18">18"</option>
                        <option value="24">24"</option>
                    </select>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Wire Buffer (%)</label>
                    <input type="number" class="form-input" id="wire-buffer" value="10" min="0" max="50">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <span>üë•</span>
                        Crew Count
                    </label>
                    <select class="form-select" id="crew-count">
                        <option value="1" selected>1 Crew</option>
                        <option value="2">2 Crews</option>
                        <option value="3">3 Crews</option>
                        <option value="4">4 Crews</option>
                    </select>
                </div>
            </div>
            
            <p style="color: #64748b; text-align: center; margin-top: 16px;">
                Start measuring to see material estimates
            </p>
            
            <!-- Material Breakdown (shown after measurements) -->
            <div class="material-breakdown" id="material-breakdown">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Generate Quote Data -->
        <button class="generate-quote-btn" onclick="generateQuote()">
            <span>üìä</span>
            Generate Quote Data
        </button>
        <p class="export-note">
            Exports structured data ready for GHL proposal system
        </p>
    </div>

    <!-- Live Stats -->
    <div id="live-stats" class="live-stats">
        <h4>Current Segment</h4>
        <p>Type: <strong id="current-type">perimeter</strong></p>
        <p>Points: <strong id="current-points">0</strong></p>
        <p>Distance: <strong id="current-distance">0.0 ft</strong></p>
    </div>

    <script>
        // Google Maps API Key
        const API_KEY = 'AIzaSyBqiqFF63IrlciAk2qygXLg6Mf8Awln0-g';
        
        // Application State
        let map = null;
        let measurements = [];
        let currentMeasurement = [];
        let currentType = 'perimeter';
        let isDrawing = false;
        let activePolyline = null;
        let clickListener = null;
        let savedPolylines = [];
        let savedMarkers = [];
        
        // Pricing Configuration
        const basePricing = {
            ledLight: 0.85,
            wire: 0.18,
            clip: 0.32,
            laborRate: 1.50
        };
        
        const complexityMultipliers = {
            stories: {
                1: 1.0,
                2: 1.3,
                3: 1.6
            },
            difficulty: {
                easy: 0.8,
                medium: 1.0,
                hard: 1.3,
                extreme: 1.6
            }
        };
        
        // Initialize Google Maps
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 31.9973, lng: -102.0779 }, // Midland, TX
                zoom: 18,
                mapTypeId: 'satellite'
            });
        }
        
        // Load Google Maps script
        function loadGoogleMaps() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=geometry&callback=initMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
        
        // Load property
        function loadProperty() {
            const address = document.getElementById('property-address').value;
            if (!address || !map) return;
            
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: address }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    map.setCenter(results[0].geometry.location);
                    map.setZoom(20);
                } else {
                    alert('Address not found. Please check the address and try again.');
                }
            });
        }
        
        // Set measurement type
        function setMeasurementType(type) {
            currentType = type;
            document.getElementById('current-type').textContent = type;
            
            // Update button styles
            document.querySelectorAll('.measurement-btn').forEach(btn => {
                btn.style.opacity = '0.6';
            });
            document.querySelector(`.measurement-btn.${type}`).style.opacity = '1';
        }
        
        // Start measuring
        function startMeasuring() {
            if (!map) {
                alert('Please load a property first');
                return;
            }
            
            isDrawing = true;
            currentMeasurement = [];
            document.getElementById('live-stats').style.display = 'block';
            
            // Add click listener to map
            clickListener = map.addListener('click', function(event) {
                if (!isDrawing) return;
                
                const point = {
                    lat: event.latLng.lat(),
                    lng: event.latLng.lng()
                };
                
                currentMeasurement.push(point);
                updateCurrentPolyline();
                updateLiveStats();
            });
            
            // Update button
            const btn = document.querySelector('.start-measuring-btn');
            btn.innerHTML = '<span>üíæ</span> Save Measurement';
            btn.onclick = saveMeasurement;
        }
        
        // Update current polyline
        function updateCurrentPolyline() {
            if (activePolyline) {
                activePolyline.setMap(null);
            }
            
            if (currentMeasurement.length > 1) {
                const colors = {
                    perimeter: '#dc2626',
                    ridge: '#2563eb',
                    ground: '#059669'
                };
                
                activePolyline = new google.maps.Polyline({
                    path: currentMeasurement,
                    geodesic: true,
                    strokeColor: colors[currentType],
                    strokeOpacity: 1.0,
                    strokeWeight: 3,
                    map: map
                });
            }
        }
        
        // Update live stats
        function updateLiveStats() {
            document.getElementById('current-points').textContent = currentMeasurement.length;
            
            if (currentMeasurement.length > 1) {
                const distance = calculateDistance(currentMeasurement);
                document.getElementById('current-distance').textContent = distance.toFixed(1) + ' ft';
            }
        }
        
        // Calculate distance
        function calculateDistance(points) {
            if (points.length < 2) return 0;
            
            let totalDistance = 0;
            for (let i = 0; i < points.length - 1; i++) {
                const distance = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(points[i].lat, points[i].lng),
                    new google.maps.LatLng(points[i + 1].lat, points[i + 1].lng)
                );
                totalDistance += distance;
            }
            
            return totalDistance * 3.28084; // Convert to feet
        }
        
        // Save measurement
        function saveMeasurement() {
            if (currentMeasurement.length < 2) {
                alert('Please add at least 2 points to create a measurement');
                return;
            }
            
            const measurement = {
                type: currentType,
                points: currentMeasurement,
                distance: calculateDistance(currentMeasurement)
            };
            
            measurements.push(measurement);
            
            // Clear current measurement
            currentMeasurement = [];
            isDrawing = false;
            
            if (activePolyline) {
                activePolyline.setMap(null);
                activePolyline = null;
            }
            
            if (clickListener) {
                google.maps.event.removeListener(clickListener);
            }
            
            // Update UI
            document.getElementById('live-stats').style.display = 'none';
            const btn = document.querySelector('.start-measuring-btn');
            btn.innerHTML = '<span>‚ö°</span> Start Measuring';
            btn.onclick = startMeasuring;
            
            // Redraw all measurements
            drawAllMeasurements();
            updateDistanceResults();
            updateMaterialBreakdown();
        }
        
        // Draw all saved measurements
        function drawAllMeasurements() {
            // Clear existing
            savedPolylines.forEach(line => line.setMap(null));
            savedMarkers.forEach(marker => marker.setMap(null));
            savedPolylines = [];
            savedMarkers = [];
            
            const colors = {
                perimeter: '#dc2626',
                ridge: '#2563eb',
                ground: '#059669'
            };
            
            measurements.forEach(measurement => {
                // Draw polyline
                const polyline = new google.maps.Polyline({
                    path: measurement.points,
                    geodesic: true,
                    strokeColor: colors[measurement.type],
                    strokeOpacity: 1.0,
                    strokeWeight: 3,
                    map: map
                });
                savedPolylines.push(polyline);
                
                // Draw markers
                measurement.points.forEach(point => {
                    const marker = new google.maps.Marker({
                        position: point,
                        map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 4,
                            fillColor: colors[measurement.type],
                            fillOpacity: 1,
                            strokeColor: 'white',
                            strokeWeight: 2
                        }
                    });
                    savedMarkers.push(marker);
                });
            });
        }
        
        // Update distance results
        function updateDistanceResults() {
            const resultsDiv = document.getElementById('distance-results');
            
            if (measurements.length === 0) {
                resultsDiv.innerHTML = 'No measurements yet';
                return;
            }
            
            const totals = {
                perimeter: 0,
                ridge: 0,
                ground: 0
            };
            
            measurements.forEach(m => {
                totals[m.type] += m.distance;
            });
            
            let html = '';
            if (totals.perimeter > 0) {
                html += `<div style="color: #dc2626; margin: 8px 0;">üî¥ Perimeter: ${totals.perimeter.toFixed(1)} ft</div>`;
            }
            if (totals.ridge > 0) {
                html += `<div style="color: #2563eb; margin: 8px 0;">üîµ Ridge: ${totals.ridge.toFixed(1)} ft</div>`;
            }
            if (totals.ground > 0) {
                html += `<div style="color: #059669; margin: 8px 0;">üü¢ Ground: ${totals.ground.toFixed(1)} ft</div>`;
            }
            
            const total = totals.perimeter + totals.ridge + totals.ground;
            html += `<div style="font-weight: 600; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0;">Total: ${total.toFixed(1)} ft</div>`;
            
            resultsDiv.innerHTML = html;
        }
        
        // Update material breakdown
        function updateMaterialBreakdown() {
            const breakdownDiv = document.getElementById('material-breakdown');
            
            if (measurements.length === 0) {
                breakdownDiv.style.display = 'none';
                return;
            }
            
            const totalDistance = measurements.reduce((sum, m) => sum + m.distance, 0);
            
            // Get form values
            const lightSpacing = parseInt(document.getElementById('light-spacing').value);
            const clipSpacing = parseInt(document.getElementById('clip-spacing').value);
            const wireBuffer = parseInt(document.getElementById('wire-buffer').value) / 100;
            const crewCount = parseInt(document.getElementById('crew-count').value);
            const profitMargin = parseInt(document.getElementById('profit-margin').value) / 100;
            const stories = parseInt(document.getElementById('stories').value);
            const difficulty = document.getElementById('difficulty').value;
            
            // Calculate quantities
            const lightsNeeded = Math.ceil(totalDistance * 12 / lightSpacing);
            const clipsNeeded = Math.ceil(totalDistance * 12 / clipSpacing);
            const wireNeeded = Math.ceil(totalDistance * (1 + wireBuffer));
            
            // Calculate costs
            const lightsCost = lightsNeeded * basePricing.ledLight;
            const clipsCost = clipsNeeded * basePricing.clip;
            const wireCost = wireNeeded * basePricing.wire;
            
            // Calculate labor with complexity
            const storyMultiplier = complexityMultipliers.stories[stories];
            const difficultyMultiplier = complexityMultipliers.difficulty[difficulty];
            const laborCost = totalDistance * basePricing.laborRate * storyMultiplier * difficultyMultiplier * crewCount;
            
            const subtotal = lightsCost + clipsCost + wireCost + laborCost;
            const profit = subtotal * profitMargin;
            const total = subtotal + profit;
            
            const showBreakdown = document.getElementById('show-breakdown').value === 'yes';
            
            if (showBreakdown) {
                breakdownDiv.innerHTML = `
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <h4 style="margin-bottom: 16px; color: #1e293b;">Material Breakdown</h4>
                        
                        <div class="material-item">
                            <div>
                                <div class="material-name">LED Lights</div>
                                <div class="material-details">${lightsNeeded} lights √ó $${basePricing.ledLight}</div>
                            </div>
                            <div class="material-cost">$${lightsCost.toFixed(2)}</div>
                        </div>
                        
                        <div class="material-item">
                            <div>
                                <div class="material-name">Wire</div>
                                <div class="material-details">${wireNeeded} ft √ó $${basePricing.wire}</div>
                            </div>
                            <div class="material-cost">$${wireCost.toFixed(2)}</div>
                        </div>
                        
                        <div class="material-item">
                            <div>
                                <div class="material-name">Clips</div>
                                <div class="material-details">${clipsNeeded} clips √ó $${basePricing.clip}</div>
                            </div>
                            <div class="material-cost">$${clipsCost.toFixed(2)}</div>
                        </div>
                        
                        <div class="material-item">
                            <div>
                                <div class="material-name">Installation Labor</div>
                                <div class="material-details">${totalDistance.toFixed(1)} ft √ó $${basePricing.laborRate} √ó ${storyMultiplier} √ó ${difficultyMultiplier} √ó ${crewCount}</div>
                            </div>
                            <div class="material-cost">$${laborCost.toFixed(2)}</div>
                        </div>
                        
                        <div class="material-item" style="border-bottom: 2px solid #e2e8f0; margin-bottom: 16px;">
                            <div>
                                <div class="material-name">Subtotal</div>
                            </div>
                            <div class="material-cost">$${subtotal.toFixed(2)}</div>
                        </div>
                        
                        <div class="material-item">
                            <div>
                                <div class="material-name">Profit (${(profitMargin * 100).toFixed(0)}%)</div>
                            </div>
                            <div class="material-cost">$${profit.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <div class="total-section">
                        <div class="total-label">Total Quote</div>
                        <div class="total-amount">$${total.toFixed(2)}</div>
                    </div>
                `;
            } else {
                breakdownDiv.innerHTML = `
                    <div class="total-section" style="margin-top: 20px;">
                        <div class="total-label">Total Quote</div>
                        <div class="total-amount">$${total.toFixed(2)}</div>
                    </div>
                `;
            }
            
            breakdownDiv.style.display = 'block';
        }
        
        // Generate quote
        function generateQuote() {
            if (measurements.length === 0) {
                alert('Please add measurements before generating a quote');
                return;
            }
            
            const totalDistance = measurements.reduce((sum, m) => sum + m.distance, 0);
            
            // Get all form values for quote data
            const quoteData = {
                property: {
                    address: document.getElementById('property-address').value
                },
                measurements: {
                    perimeter: measurements.filter(m => m.type === 'perimeter').reduce((sum, m) => sum + m.distance, 0),
                    ridge: measurements.filter(m => m.type === 'ridge').reduce((sum, m) => sum + m.distance, 0),
                    ground: measurements.filter(m => m.type === 'ground').reduce((sum, m) => sum + m.distance, 0),
                    total: totalDistance
                },
                configuration: {
                    stories: parseInt(document.getElementById('stories').value),
                    difficulty: document.getElementById('difficulty').value,
                    lightSpacing: parseInt(document.getElementById('light-spacing').value),
                    clipSpacing: parseInt(document.getElementById('clip-spacing').value),
                    wireBuffer: parseInt(document.getElementById('wire-buffer').value),
                    crewCount: parseInt(document.getElementById('crew-count').value),
                    profitMargin: parseInt(document.getElementById('profit-margin').value)
                },
                timestamp: new Date().toISOString()
            };
            
            // For now, just show the data in console and alert
            console.log('Quote Data for GHL:', quoteData);
            alert('Quote data generated! Check browser console for structured data ready for GHL import.');
            
            // In a real implementation, this would send to your GHL system
        }
        
        // Zoom tool functionality
        let zoomModeActive = false;
        let zoomSelectionActive = false;
        let zoomRectangle = null;
        let originalZoom = null;
        let originalCenter = null;
        
        // Activate zoom tool
        function activateZoomTool() {
            if (!map) {
                alert('Please load a property first');
                return;
            }
            
            zoomModeActive = true;
            document.getElementById('zoom-controls').style.display = 'block';
            
            // Store original view
            originalZoom = map.getZoom();
            originalCenter = map.getCenter();
            
            // Update button styles
            document.querySelectorAll('.measurement-btn').forEach(btn => {
                btn.style.opacity = '0.6';
            });
            document.querySelector('.measurement-btn.zoom').style.opacity = '1';
        }
        
        // Select zoom area
        function selectZoomArea() {
            if (!map || !zoomModeActive) return;
            
            zoomSelectionActive = true;
            let startPoint = null;
            let endPoint = null;
            
            // Clear any existing rectangle
            if (zoomRectangle) {
                zoomRectangle.setMap(null);
            }
            
            // Add mouse down listener
            const mouseDownListener = map.addListener('mousedown', function(event) {
                startPoint = event.latLng;
            });
            
            // Add mouse up listener
            const mouseUpListener = map.addListener('mouseup', function(event) {
                if (!startPoint) return;
                
                endPoint = event.latLng;
                
                // Create bounds from the selected area
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(startPoint);
                bounds.extend(endPoint);
                
                // Create visual rectangle
                zoomRectangle = new google.maps.Rectangle({
                    bounds: bounds,
                    editable: false,
                    draggable: false,
                    fillColor: '#f59e0b',
                    fillOpacity: 0.2,
                    strokeColor: '#f59e0b',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    map: map
                });
                
                // Zoom to the selected area with artificial zoom
                map.fitBounds(bounds);
                
                // Add extra zoom beyond Google's limits
                setTimeout(() => {
                    const currentZoom = map.getZoom();
                    if (currentZoom < 25) {
                        map.setZoom(Math.min(currentZoom + 3, 25));
                    }
                }, 500);
                
                // Clean up listeners
                google.maps.event.removeListener(mouseDownListener);
                google.maps.event.removeListener(mouseUpListener);
                
                zoomSelectionActive = false;
            });
        }
        
        // Reset zoom
        function resetZoom() {
            if (!map || !originalZoom || !originalCenter) return;
            
            // Clear zoom rectangle
            if (zoomRectangle) {
                zoomRectangle.setMap(null);
                zoomRectangle = null;
            }
            
            // Restore original view
            map.setZoom(originalZoom);
            map.setCenter(originalCenter);
        }
        
        // Exit zoom mode
        function exitZoomMode() {
            zoomModeActive = false;
            zoomSelectionActive = false;
            
            // Hide zoom controls
            document.getElementById('zoom-controls').style.display = 'none';
            
            // Clear zoom rectangle
            if (zoomRectangle) {
                zoomRectangle.setMap(null);
                zoomRectangle = null;
            }
            
            // Reset button styles
            document.querySelectorAll('.measurement-btn').forEach(btn => {
                btn.style.opacity = '1';
            });
            
            // Reset to default measurement type
            setMeasurementType('perimeter');
        }
        
        // Initialize when page loads
        window.onload = function() {
            loadGoogleMaps();
            
            // Set default measurement type
            setMeasurementType('perimeter');
            
            // Add event listeners for real-time updates
            ['stories', 'difficulty', 'light-spacing', 'clip-spacing', 'wire-buffer', 'crew-count', 'profit-margin', 'show-breakdown'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateMaterialBreakdown);
            });
        };
    </script>
</body>
</html>